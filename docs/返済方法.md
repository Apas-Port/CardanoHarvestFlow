# NFT保有者への返済（エアドロップ）方法

このドキュメントでは、NFT保有者に対して保有数に応じたADAをエアドロップ（返済）する方法を説明します。

## 概要

`scripts:airdrop` コマンドを使用して、プロジェクトのNFT保有者に対して、保有しているNFT数 × 指定したADA数をまとめて送金します。

## 事前準備

### 環境変数の設定

`.env` ファイルに以下の環境変数が設定されている必要があります：

```bash
# Blockfrost API キー
BLOCKFROST_API_KEY=<preprod 用キー>
BLOCKFROST_MAINNET_API_KEY=<mainnet 用キー>

# ウォレット設定（送金元）
PAYMENT_MNEMONIC="<12語または24語のニーモニック>"
```

> **重要**: `PAYMENT_MNEMONIC` は **絶対に Git にコミットしないでください**。

### ウォレット残高の確認

送金前に、送金元ウォレットに十分な残高があることを確認してください。必要な残高は以下の通りです：

- 送金額合計 = 全保有者のNFT数合計 × ADA/NFT
- トランザクション手数料 = 約0.2 ADA × バッチ数（概算）
- **必要残高 = 送金額合計 + トランザクション手数料**

## 基本的な使用方法

### 1. 初回実行

```bash
pnpm scripts:airdrop <project-id> <network> <ada-per-nft>
```

**パラメータ:**
- `project-id`: プロジェクトID（例: `001`, `002`）
- `network`: ネットワーク（`preprod` または `mainnet`）
- `ada-per-nft`: NFT 1個あたりの返済ADA数（例: `10`）

**実行例:**
```bash
# preprod でプロジェクト 001 の保有者に NFT 1個あたり 10 ADA を送金
pnpm scripts:airdrop 001 preprod 10

# mainnet でプロジェクト 002 の保有者に NFT 1個あたり 5 ADA を送金
pnpm scripts:airdrop 002 mainnet 5
```

### 2. 実行の流れ

1. **NFT保有者の取得**: プロジェクトのNFT保有者一覧を取得します
2. **送金額の計算**: 各アドレスの保有数 × ADA/NFT を計算します
3. **残高確認**: ウォレット残高が十分か確認します
4. **送金内容の確認（2ステップ）**: 送金内容を表示し、ユーザーの確認を得てから送金を実行します
   - 送金先アドレス一覧（最大20件表示）
   - 各アドレスの保有NFT数と送金額
   - 合計送金額
   - ウォレット残高と必要残高
   - 確認プロンプトで `y` または `yes` を入力すると送金を実行、それ以外でキャンセル
5. **バッチ処理**: トランザクションサイズ制限を考慮して、50アドレスずつバッチ処理します
6. **ログ保存**: 各トランザクションの結果をJSON形式でログに記録します

> **重要**: 送金はリスクが高い操作のため、送金内容を確認してから実行する2ステップ方式になっています。送金内容をよく確認し、問題がなければ `y` を入力して実行してください。

### 3. 実行例の出力

```
🚀 Starting airdrop refund for project 001 on preprod
   ADA per NFT: 10

📊 Fetching NFT holders...
Total holders: 25
Already processed: 0
Pending: 25

💰 Total refund amount: 250 ADA
   (250000000 lovelace)

💼 Wallet balance: 500 ADA
   Required: 250.5 ADA (including estimated fees)

================================================================================
📋 Airdrop Preview
================================================================================
Project ID: 001
Network: preprod
ADA per NFT: 10
Recipients: 25
Estimated batches: 1

Recipient List:
--------------------------------------------------------------------------------
  1. addr1qxxxxx...
     NFTs: 5 → Amount: 50 ADA
  2. addr1qyyyyy...
     NFTs: 3 → Amount: 30 ADA
  ... 23 more addresses
--------------------------------------------------------------------------------
Total amount: 250 ADA
   (250000000 lovelace)

Wallet Info:
  Current balance: 500 ADA
  Required balance: 250.5 ADA
  Balance difference: 249.5 ADA
================================================================================

Proceed with the airdrop? (y/N): y

✅ Proceeding with airdrop...

📦 Processing 25 recipients in batches of 50...

[Batch 1/1] Processing 25 recipients...
  ✅ Success! TX: abc123def456...

============================================================
📊 Summary:
   Successful: 25 addresses
   Failed: 0 addresses
   Total sent: 250 ADA
   Log file: logs/airdrop-001-preprod-2024-01-01T12-00-00.json
============================================================
```

**確認プロンプトの動作:**
- `y` または `yes` を入力すると送金を実行します
- それ以外（Enterキー、`n`、`no` など）を入力すると送金がキャンセルされます
- デフォルトは `N`（実行しない）です

## 再実行（失敗したアドレスのみ処理）

途中でエラーが発生した場合、既に成功したアドレスをスキップして、失敗したアドレスのみを再実行できます。

### 再実行コマンド

```bash
pnpm scripts:airdrop <project-id> <network> <ada-per-nft> --resume-from=<log-file>
```

**実行例:**
```bash
# 前回のログファイルから再実行
pnpm scripts:airdrop 001 preprod 10 --resume-from=logs/airdrop-001-preprod-2024-01-01T12-00-00.json
```

### 再実行の動作

1. 指定されたログファイルを読み込みます
2. ログ内で `status: "success"` かつ `txHash` が存在するトランザクションのアドレスを抽出します
3. これらのアドレスをスキップして、残りのアドレスのみを処理します
4. 新しいログファイルに結果を記録します（既存のログは上書きされません）

> **重要**: 既に成功したアドレスには **絶対に再送金されません**。ログファイル内で成功と記録されているアドレスは自動的にスキップされます。

## ログファイル

### ログファイルの場所

ログファイルは `logs/` ディレクトリに保存されます。

ファイル名形式: `airdrop-<project-id>-<network>-<timestamp>.json`

例: `airdrop-001-preprod-2024-01-01T12-00-00.json`

### ログファイルの構造

```json
{
  "timestamp": "2024-01-01T12:00:00.000Z",
  "projectId": "001",
  "network": "preprod",
  "adaPerNft": 10,
  "totalHolders": 25,
  "totalAmount": "250000000",
  "transactions": [
    {
      "txHash": "abc123def456...",
      "addresses": ["addr1...", "addr2..."],
      "amounts": ["10000000", "50000000"],
      "status": "success",
      "timestamp": "2024-01-01T12:00:05.000Z"
    },
    {
      "txHash": null,
      "addresses": ["addr3..."],
      "amounts": ["20000000"],
      "status": "failed",
      "error": "Insufficient balance",
      "timestamp": "2024-01-01T12:00:10.000Z"
    }
  ],
  "summary": {
    "successful": 24,
    "failed": 1,
    "totalSent": "240000000"
  }
}
```

### ログファイルの確認方法

```bash
# JSONファイルを整形して表示
cat logs/airdrop-001-preprod-2024-01-01T12-00-00.json | jq .

# 成功したトランザクションのみ表示
cat logs/airdrop-001-preprod-2024-01-01T12-00-00.json | jq '.transactions[] | select(.status == "success")'

# 失敗したトランザクションのみ表示
cat logs/airdrop-001-preprod-2024-01-01T12-00-00.json | jq '.transactions[] | select(.status == "failed")'
```

## 注意事項

### セキュリティ

- `PAYMENT_MNEMONIC` は **絶対に Git にコミットしないでください**
- `.env` ファイルが `.gitignore` に含まれていることを確認してください
- 本番環境（mainnet）で実行する前に、必ず preprod でテストしてください

### トランザクションサイズ制限

Cardanoのトランザクションには約16KBのサイズ制限があります。そのため、スクリプトは自動的に50アドレスずつバッチ処理します。

大量のアドレスがある場合、複数のトランザクションに分割されます。各トランザクションの送信後、2秒待機してから次のバッチを処理します（Blockfrost APIのレート制限を考慮）。

### エラーハンドリング

- トランザクション送信に失敗した場合、エラー内容がログに記録されます
- 失敗したアドレスは再実行時に処理されます
- ネットワークエラーやAPI制限エラーの場合、ログを確認して再実行してください

### 残高不足の場合

ウォレット残高が不足している場合、スクリプトは実行前にエラーを表示して終了します。

```
❌ Error: Insufficient balance. Need 250.5 ADA, but have 200 ADA
```

この場合、ウォレットに十分な残高を追加してから再実行してください。

### ログファイルの管理

- ログファイルは `logs/` ディレクトリに保存されます
- `.gitignore` に `logs/` が含まれているため、Gitにはコミットされません
- 重要なログファイルは手動でバックアップしてください

## トラブルシューティング

### よくあるエラー

#### 1. `PAYMENT_MNEMONIC is not set in .env`
- `.env` ファイルに `PAYMENT_MNEMONIC` が設定されているか確認してください

#### 2. `Missing Blockfrost API key for <network>`
- `.env` ファイルに適切なBlockfrost APIキーが設定されているか確認してください
- preprod の場合は `BLOCKFROST_API_KEY`
- mainnet の場合は `BLOCKFROST_MAINNET_API_KEY`

#### 3. `Project <project-id> not found`
- プロジェクトIDが正しいか確認してください
- `public/data/dev-projects.json` (preprod) または `public/data/projects.json` (mainnet) にプロジェクトが存在するか確認してください

#### 4. `No UTXOs available`
- ウォレットにUTXOが存在しない可能性があります
- ウォレットに少量のADAを送金してから再試行してください

#### 5. `Failed to create collateral`
- Collateral UTxOの作成に失敗しました
- ウォレットに十分な残高があるか確認してください（Collateral作成には約5 ADA必要です）

### 再実行時の注意

- 再実行時は、**必ず同じ `ada-per-nft` の値を指定してください**
- 異なる値を指定すると、送金額が変わってしまいます
- ログファイルのパスは、前回実行時に表示されたパスをそのまま使用してください

## 関連コマンド

- `pnpm scripts:list <project-id> <network>`: NFT保有者一覧を表示（送金前の確認用）

