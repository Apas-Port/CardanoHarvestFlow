# 新しいプロジェクトの追加方法

Harvestflow で新しいプロジェクトを公開するときは、ローカル環境の準備、オンチェーンの初期化、そして Vercel への反映という順序で作業します。ここでは `scripts/init-project.ts` を使った手順を説明します。

## 0. 事前準備

最初にリポジトリをクローンし、依存関係をインストールしてください。

```bash
pnpm install
```

### 環境変数の設定

環境変数はプロジェクトルートの `.env` ファイルで管理します。以下の内容を追加してください：

```bash
# ネットワーク設定
CARDANO_NETWORK=preprod
NEXT_PUBLIC_CARDANO_NETWORK=preprod

# Blockfrost API キー
BLOCKFROST_API_KEY=<preprod 用キー>
BLOCKFROST_MAINNET_API_KEY=<mainnet 用キー>

# Treasury アドレス（ミント売上を受け取るアドレス）
NEXT_PUBLIC_PROJECT_TREASURY_ADDRESS=<mainnet 用アドレス>
NEXT_PUBLIC_PROJECT_TREASURY_ADDRESS_DEV=<preprod 用アドレス>

# ウォレット設定（ローカル開発用）
PAYMENT_MNEMONIC="<12語または24語のニーモニック>"
# PAYMENT_ACCOUNT_INDEX=0
# PAYMENT_ADDRESS_INDEX=0
# PAYMENT_MNEMONIC_PASSPHRASE=

# プロジェクト固有のパラメータ UTXO（init コマンド実行後に自動追加）
# PARAM_UTXO_PROJECT_NAME='{"outputIndex": 0, "txHash": "..."}'
```
Lace などで複数アカウントを運用している場合は、`PAYMENT_ACCOUNT_INDEX` と `PAYMENT_ADDRESS_INDEX` を実際の利用状況に合わせて変更します。

> **セキュリティに関する注意**:
> - `PAYMENT_MNEMONIC` は **絶対に Git にコミットしないでください**。
> - `.env` ファイルが `.gitignore` に含まれていることを確認してください。
> - 本番環境では Vercel の環境変数設定を使用してください。

## 1. プロジェクト JSON の編集

新しいプロジェクトを追加するときは、まず `public/data/dev-projects.json` に次のようなオブジェクトを追加します。`id` は一意の文字列（例: "001", "002"）にします。

```json
{
  "id": "002",
  "num": 2,
  "title": "プロジェクト名",
  "subTitle": "サブタイトル",
  "description": "プロジェクト概要",
  "apy": 8.0,
  "lendingType": "ADA",
  "network": "Cardano",
  "capacity": 300,
  "unitPrice": 1,
  "collectionName": "Harvestflow",
  "mainImage": "/images/project/2/main.png",
  "previewImage": "/images/project/2/preview.jpg",
  "tuktukImage": "/images/project/2/tuktuk.png",
  "policyId": "",
  "legacyPolicyIds": [],
  "status": "active",
  "interestEarned": "base number",
  "interestRate": 8.0,
  "repaymentMethod": "AT MATURITY",
  "lendingPeriod": 12,
  "assetId": ["79", "80", "81"],
  "startDate": "1 Oct 2025",
  "listing": true,
  "maxMints": 100,
  "paramUtxoEnvKey": "PARAM_UTXO_PROJECT_2",
  "mintPriceLovelace": 1969750,
  "metadata": {
    "name": "Harvestflow Project NFT",
    "image": "ipfs://QmY53cEvybvh9BkHjgGeP2C8mG5FEjLcnVjegkGeTmqEQ1",
    "description": "Support the project through this NFT",
    "mediaType": "image/png",
    "attributes": [
      {
        "trait_type": "Collection",
        "value": "Harvestflow"
      },
      {
        "trait_type": "Project",
        "value": "Project Name"
      },
      {
        "trait_type": "APY",
        "value": "8%"
      },
      {
        "trait_type": "Lending Period",
        "value": "12 months"
      }
    ]
  }
}
```

> **⚠️ メタデータの長さ制限について**:
> - Cardanoのメタデータには**各項目が64バイト以下**という制限があります。
> - `metadata`オブジェクト内のすべてのフィールド（`name`, `description`, `image`（IPFS CID部分）、`attributes`内の各値など）が64バイト以下である必要があります。
> - メタデータの長さをチェックするには、`pnpm run scripts:check-metadata` コマンドを実行してください。
> - このコマンドは `public/data/projects.json` と `public/data/dev-projects.json` の両方を自動的にチェックします。
> - エラーが検出された場合は、ミント前にメタデータを修正してください。

#### 各フィールドの分類

| フィールド | 分類 | 用途・説明 |
| --- | --- | --- |
| `id`, `num` | UI表示用 | プロジェクト識別子・番号 |
| `title`, `subTitle`, `description` | UI表示用 | プロジェクト説明文 |
| `lendingType`, `network` | UI表示用 | プロジェクト分類情報 |
| `capacity`, `unitPrice` | UI表示用 | UI での表示用パラメータ |
| `mainImage`, `previewImage`, `tuktukImage` | UI表示用 | 画像パス |
| `status`, `listing` | UI表示用 | プロジェクト状態・一覧表示フラグ |
| `interestEarned`, `interestRate`, `repaymentMethod` | UI表示用 | 利息情報（表示のみ） |
| `assetId`, `startDate` | UI表示用 | 関連情報（表示用） |
| `legacyPolicyIds` | UI表示用 | 旧ポリシーID（検証・互換性維持用） |
| `apy` | ブロックチェーン初期化時 | Oracle の `expectedAprNumerator` に登録 |
| `lendingPeriod` | ブロックチェーン初期化時 | `maturationTime` の計算に使用（月単位） |
| `maxMints` | ブロックチェーン初期化時 | Oracle の `maxMints` に登録 |
| `mintPriceLovelace` | ブロックチェーン初期化時 | Oracle の `lovelacePrice` に登録（例: 1969750 = 1.96975 ADA）1.5ADA以下だとUTxO最小値を下回ってミントエラーになる可能性あり |
| `collectionName` | ブロックチェーン・UI両方 | NFT コレクション名（ブロックチェーンでも使用） |
| `policyId` | ブロックチェーンから取得 | `init` 実行後に Oracle から自動生成・更新 |
| `paramUtxoEnvKey` | サーバー側設定 | 環境変数キー名（Oracle UTxO 参照用） |
| `metadata` | NFTメタデータ | NFT ミント時に使用されるメタデータ |

画像は `public/images/project/<num>/` に配置します。将来的に mainnet へ公開するときは、同じ構造を `public/data/projects.json` にコピーしてください。

### データ構造の理解

プロジェクトを追加する際、**ブロックチェーン上に登録される情報**と**フロントエンドで保持する情報**を区別することが重要です。

#### ブロックチェーン上に登録される情報（Oracle Datum）

以下の情報は `init-project.ts` 実行時にブロックチェーン上の Oracle UTxO に永続的に記録されます。これらはコントラクトのロジックで使用され、変更にはトランザクションが必要です。

| フィールド | 説明 | データ型 | 対応する JSON フィールド |
| --- | --- | --- | --- |
| `nftIndex` | 現在のNFTインデックス（ミントごとに自動増加） | Integer | （動的に更新、JSONには保存されない） |
| `lovelacePrice` | NFTのミント価格（Lovelace単位） | Integer | `mintPriceLovelace` |
| `feeCollectorAddress` | 手数料収集アドレス（pubKeyHash + stakeCredentialHash） | PubKeyAddress | （ネットワーク設定から自動取得） |
| `nftMintAllowed` | ミント許可フラグ | Bool | （初期化時に `true` に設定、後で変更可能） |
| `nftTradeAllowed` | トレード許可フラグ | Bool | （初期化時に `true` に設定、後で変更可能） |
| `expectedAprNumerator` | APRの分子 | Integer | `apy`（数値そのまま） |
| `expectedAprDenominator` | APRの分母 | Integer | 固定値 `100` |
| `maturationTime` | 満期時刻（Unix タイムスタンプ） | Integer | `startDate` + `lendingPeriod` から計算 |
| `maxMints` | 最大ミント数 | Integer | `maxMints` |

**ブロックチェーン上で生成・参照される情報**:
- `policyId`: Oracle UTxO のパラメータから生成されるNFTポリシーID（`init-project.ts` 実行後に JSON に書き戻される）
- `paramUtxo`: Oracle UTxO の参照情報（`txHash`, `outputIndex`）→ 環境変数 `.env` で管理

#### フロントエンドで保持する情報（dev-projects.json / projects.json）

以下の情報は JSON ファイルで管理され、UI の表示やフィルタリングに使用されます。ブロックチェーンには登録されません。

**UI表示用（ブロックチェーンと無関係）**:
- `id`, `num`: プロジェクト識別子
- `title`, `subTitle`, `description`: プロジェクト説明文
- `mainImage`, `previewImage`, `tuktukImage`: 画像パス
- `status`: プロジェクト状態（`"active"`, `"inactive"` など）
- `listing`: 一覧表示の有無
- `assetId`: 関連アセットID（表示用）
- `interestEarned`, `interestRate`, `repaymentMethod`: 利息情報（表示用）
- `lendingType`, `network`: プロジェクト分類（表示用）
- `capacity`, `unitPrice`: UI での表示用パラメータ

**ブロックチェーン初期化時に使用（初期化後はブロックチェーンから取得が優先）**:
- `apy`: Oracle に登録される APR の分子として使用（初期化後は Oracle から読み取る）
- `lendingPeriod`: `maturationTime` の計算に使用
- `maxMints`: Oracle に登録される最大ミント数として使用
- `mintPriceLovelace`: Oracle に登録される価格として使用
- `collectionName`: NFT コレクション名として使用（ブロックチェーンでも参照）

**ブロックチェーンから取得した値を保持**:
- `policyId`: Oracle 初期化後に自動更新される
- `paramUtxoEnvKey`: 環境変数キー名（サーバー側で Oracle UTxO を取得する際に使用）

**NFTメタデータ用**:
- `metadata`: NFT ミント時に使用されるメタデータ（IPFS への登録も可能）

#### データの同期について

- **初期化時**: `dev-projects.json` の値が Oracle に登録されます
- **初期化後**: `policyId` が JSON に自動的に書き戻されます
- **実行時**: ミントやオラクル状態確認時は、ブロックチェーン上の Oracle から最新の状態（価格、ミント数、許可フラグなど）を取得します

> **注意**: `apy`, `lendingPeriod`, `maxMints`, `mintPriceLovelace` などは JSON にも保持されますが、実際のコントラクト動作では**ブロックチェーン上の Oracle の値が優先**されます。JSON の値と Oracle の値が異なる場合は、Oracle の値が使用されます。

## 2. オンチェーン初期化

### 2.1 ウォレット残高の確認

プロトコル初期化の前に、ウォレットの残高を確認してください：

```bash
pnpm run scripts:balance [network]
```

このコマンドで、現在のウォレットアドレスと残高（lovelace と ADA）が表示されます。プロトコル初期化には十分な ADA が必要です。

**使用例**:
```bash
# mainnet で残高確認（デフォルト）
pnpm run scripts:balance

# preprod で残高確認
pnpm run scripts:balance preprod
```

### 2.2 プロトコル初期化

`pnpm run scripts:init <project-id> [network]`

このコマンドを実行すると、`dev-projects.json` に記載された以下の情報がブロックチェーン上の Oracle UTxO に登録されます：
- `apy` → Oracle の `expectedAprNumerator`
- `lendingPeriod` → Oracle の `maturationTime`（現在時刻 + `lendingPeriod` から計算）
- `maxMints` → Oracle の `maxMints`
- `mintPriceLovelace` → Oracle の `lovelacePrice`
- `collectionName` → NFT コレクション名として使用

初回実行では担保 UTxO を作成するトランザクションが送信されるため、完了まで 10〜30 秒ほど待つことがあります。コマンドが成功すると参照 UTxO の JSON が表示され、`.env` ファイルに自動的に追加されます。同時に `public/data/dev-projects.json` の該当プロジェクトに最新の `policyId` が書き戻されます。

> **参考**: ブロックチェーン上に登録される情報の詳細については、[データ構造の理解](#データ構造の理解) セクションを参照してください。

**使用例**:
```bash
# preprod で初期化（デフォルト）
pnpm run scripts:init 002

# mainnet で初期化
pnpm run scripts:init 002 mainnet
```

**実行例**:
```shell
% pnpm run scripts:init 002

🚀 Initializing Oracle for project: 002 on preprod

📋 Project Configuration:
   - Title: プロジェクト名
   - Collection: Harvestflow
   - APY: 8%
   - Lending Period: 12 months
   - Max Mints: 100
   - Mint Price: 1.96975 ADA

🔗 Using preprod network

💼 No collateral UTxO found, creating one...

📝 Collateral creation transaction submitted: 58aa2dec5d7e3a154a93f1b37bde37dfe61e7f85d5043a670356ac2ce1ad2a8a

⏳ Waiting for collateral confirmation (30 seconds)...

✅ Collateral UTxO confirmed!

💼 Wallet Address: addr_test1qrvr7ffc2xjxk4wn5vxflernwu76la8ruqgx4nrq5q6eplv5fpsna8q8hytqhepswuavuaqg83qtnkkrndtv3jxhd7fqtxr8p8

⚙️  Oracle Parameters:
   - Lovelace Price: 1969750 (1.96975 ADA)
   - Expected APR: 8/100 (8%)
   - Maturation Time: 2026-10-01T00:00:00.000Z
   - Max Mints: 100

📦 Loading nft-contracts...

🔨 Booting Oracle...

✅ Oracle booted successfully!

📝 ParamUtxo:
   - TX Hash: bc9ec4e050ce2b0834bbcb95fee80dd8bdc59a7312b6924076d1d45a56ca0d20
   - Output Index: 2

⏳ Waiting for transaction confirmation (30 seconds)...

🔓 Enabling NFT minting...

✅ NFT minting enabled successfully!

🔑 Policy ID: e9491aa6d9aeabd3a266fbaa13aee963b05e9db4afb12f8795443d1a

💾 Saved paramUtxo to: param-utxo-002.json
💾 Updated dev-projects.json with policyId
💾 Updated .env with PARAM_UTXO_PROJECT_2

🔍 Environment Variable Confirmation:
   PARAM_UTXO_PROJECT_2='{"txHash":"bc9ec4e050ce2b0834bbcb95fee80dd8bdc59a7312b6924076d1d45a56ca0d20","outputIndex":2}'

✨ Project initialization completed!

📋 Next steps:
   1. Update your frontend .env with the new policyId
   2. Restart your development server
   3. Test minting with the new project
```

このコマンドの出力で表示された `PARAM_UTXO_xxx` の内容は、**プロジェクトルートの `.env` ファイル**に自動的に追加されます。

### 2.2 オラクル状態の確認（オプション）

`pnpm run scripts:check-oracle <project-id> [network]`

このコマンドでオラクルの状態を確認し、ミントが許可されているか、価格や供給上限が期待通りであることを確かめてください。

**使用例**:
```bash
# preprod でオラクル状態を確認（デフォルト）
pnpm run scripts:check-oracle 002

# mainnet でオラクル状態を確認
pnpm run scripts:check-oracle 002 mainnet
```

### 2.3 ミント許可の切り替え（オプション）

ミントを一時停止したいときは `pnpm run scripts:toggle-minting -- --project=<project-id> --disable` を、再開したいときは `pnpm run scripts:toggle-minting -- --project=<project-id> --enable` を実行します。

**使用例**:
```bash
# ミントを無効化
pnpm run scripts:toggle-minting -- --project=002 --disable

# ミントを有効化
pnpm run scripts:toggle-minting -- --project=002 --enable

# 現在の状態を確認
pnpm run scripts:toggle-minting -- --project=002 --status
```

### 2.4 ミント実行 & PolicyID の更新

実際に NFT をミントする場合は、`npm run dev` でフロントエンドを起動するか、サーバー API を直接呼び出します。

**Note**: 一度ミントした上で正しい PolicyID を取得し、これを `dev-projects.json` に埋め込む必要がある場合があります。PolicyID は CExplorer などのブロックエクスプローラーで確認できます。

### 2.5 ホルダー確認

`pnpm run scripts:list <project-id> <network>`

このコマンドで、指定したプロジェクトの NFT 保有者一覧を取得できます。

**使用例**:
```bash
# preprod でホルダー一覧を取得
pnpm run scripts:list 002 preprod

# mainnet でホルダー一覧を取得
pnpm run scripts:list 002 mainnet
```

**実行例**:
```shell
% pnpm run scripts:list 002 preprod

Fetching NFT holders for project 002 on preprod...

Project: プロジェクト名
Policy ID: e9491aa6d9aeabd3a266fbaa13aee963b05e9db4afb12f8795443d1a
Collection: Harvestflow

Fetching assets...
Found 2 NFTs

========================================================================================================================
Address                                                                                                         | Token IDs                      | Quantity
========================================================================================================================
addr_test1qr87g4a5jsg57ul36vnnn99aqddgkesawvgzjlshsxyhpxjngs2np8tlavv9w6xnz58snl0czq3ywsapt9dkqxpx738sthc6ty | 0, 1                           | 2
========================================================================================================================

Total holders: 1
Total NFTs: 2

Statistics:
- Average NFTs per holder: 2.00
- Largest holder: addr_test1qr87g4a5jsg57ul36vnnn99aqddgkesawvgzjlshsxyhpxjngs2np8tlavv9w6xnz58snl0czq3ywsapt9dkqxpx738sthc6ty (2 NFTs)
```

## 3. 環境変数の整理

### プロジェクトルートの `.env` に設定する環境変数

環境変数は、ブロックチェーン上の Oracle UTxO を参照するために必要な情報を保持します。これらはサーバー側でのみ使用され、クライアントには公開されません。

| キー | 分類 | 用途・説明 | 記載先 |
| --- | --- | --- | --- |
| **ブロックチェーン参照情報** ||||
| `PARAM_UTXO_<PROJECT>` | ブロックチェーン参照 | `init` コマンド実行後に自動生成されます。Oracle UTxO の位置情報（`txHash` と `outputIndex`）を含む JSON 文字列です。サーバー側で Oracle データを読み取る際に使用されます。Vercel の環境変数にも同じ名前で登録してください。 | `.env` |
| **ウォレット設定（サーバー側署名用）** ||||
| `PAYMENT_MNEMONIC` | サーバー設定 | サーバー側でトランザクション署名に使用する 12 語または 24 語のニーモニックです。**セキュリティ上、Git にコミットしないでください**。 | `.env` |
| `PAYMENT_ACCOUNT_INDEX` | サーバー設定 | Lace などで複数アカウントを扱う場合に派生パスを合わせます（デフォルト: 0）。 | `.env` |
| `PAYMENT_ADDRESS_INDEX` | サーバー設定 | Lace などで複数アドレスを扱う場合に派生パスを合わせます（デフォルト: 0）。 | `.env` |
| `PAYMENT_MNEMONIC_PASSPHRASE` | サーバー設定 | BIP39 パスフレーズを利用している場合のみ設定します。 | `.env` |
| **ネットワーク設定** ||||
| `CARDANO_NETWORK` | ネットワーク設定 | 使用するネットワーク (`preprod` または `mainnet`)。 | `.env` |
| `BLOCKFROST_API_KEY` | ネットワーク設定 | Preprod 用の Blockfrost API キー。 | `.env` |
| `BLOCKFROST_MAINNET_API_KEY` | ネットワーク設定 | Mainnet 用の Blockfrost API キー。 | `.env` |
| `NEXT_PUBLIC_PROJECT_TREASURY_ADDRESS` | ネットワーク設定 | Mainnet 用の Treasury アドレス（ミント売上を受け取るアドレス）。**必須**。 | `.env` |
| `NEXT_PUBLIC_PROJECT_TREASURY_ADDRESS_DEV` | ネットワーク設定 | Preprod 用の Treasury アドレス（ミント売上を受け取るアドレス）。**必須**。 | `.env` |

> **重要**: 
> - Vercel など本番環境にデプロイする場合は、同じ環境変数を Vercel の環境変数設定にも追加してください。
> - `NEXT_PUBLIC_PROJECT_TREASURY_ADDRESS` と `NEXT_PUBLIC_PROJECT_TREASURY_ADDRESS_DEV` は**必須**です。設定されていない場合、アプリケーションは起動時にエラーで停止します。
> - `PARAM_UTXO_*` 環境変数には、Oracle UTxO の参照情報のみが保存されます。Oracle に記録されている実際のデータ（価格、APR、ミント数など）は、サーバーが Blockfrost API 経由でブロックチェーンから読み取ります。

## 4. 動作確認

まず、メタデータの長さ制限をチェックしてください：

```bash
pnpm run scripts:check-metadata
```

このコマンドでエラーが検出された場合は、ミント前にメタデータを修正してください。

続いて、`npm run dev` でアプリケーションを起動し、トップページに新しいプロジェクトが表示されることを確認してください。続いて `npm run lint` を実行し、静的解析をパスすることを確かめます。テストミントを行った後は `pnpm run scripts:list <project-id> <network>` で保有者情報が取得できることを再確認します。

## 5. デプロイ

本番環境へ公開するときは、`public/data/projects.json` に同じエントリを追加します。`policyId` と `paramUtxoEnvKey` は本番用の値に置き換え、Vercel の環境変数も mainnet 用 (`BLOCKFROST_MAINNET_API_KEY` や `CARDANO_NETWORK=mainnet` など) に切り替えます。その上で `pnpm run scripts:init <project-id> mainnet` を実行し、本番用の参照 UTxO を作成してください。最後に Vercel へデプロイし、`pnpm run scripts:check-oracle <project-id> mainnet` で状態を確認します。

## 参考コマンド一覧

| コマンド | 説明 |
| --- | --- |
| `pnpm run scripts:init <project-id> [network]` | プロトコルを初期化し、新しい param UTxO を生成します。 |
| `pnpm run scripts:check-oracle <project-id> [network]` | オラクルに記録されている価格や状態を確認します。`network` を省略すると preprod、`mainnet` を指定すると mainnet で確認します。 |
| `pnpm run scripts:check-metadata` | メタデータの各項目が64バイト制限を超えていないかチェックします。`projects.json` と `dev-projects.json` の両方を自動的にチェックします。 |
| `pnpm run scripts:toggle-minting -- --project=<project-id> --enable` | ミントを有効化します。 |
| `pnpm run scripts:toggle-minting -- --project=<project-id> --disable` | ミントを無効化します。 |
| `pnpm run scripts:toggle-minting -- --project=<project-id> --status` | ミントの許可状態を確認します。 |
| `pnpm run scripts:list <project-id> <network>` | 最新の policyId に紐づく保有者一覧を表示します。 |

## トラブルシューティング

- `No collateral found` が表示された場合、担保 UTxO がまだ生成されていない可能性があります。トランザクションがブロックに含まれるまで数秒待ってから再実行してください。残高不足の場合は ADA を補充します。
- `ENOENT: open '/...{"txHash":...}'` が表示された場合、`.env` の `PARAM_UTXO_*` に余計なクォートが付いていることが原因です。純粋な JSON 文字列に修正してください。
- `Minting error: TxSignError` が表示された場合、ブラウザウォレットが必要な入力を保持していない可能性があります。正しいウォレットを選択するか、資金 UTxO を追加してください。
- `TxSubmitFail` が表示された場合、redeemer や datum の整合性に問題があります。エラーメッセージを確認し、価格などの設定に齟齬がないかを調べます。
- `MAX_LENGTH_LIMIT` エラーが表示された場合、メタデータの項目が64バイトを超えています。`pnpm run scripts:check-metadata` を実行して問題のある項目を特定し、修正してください。
- プロジェクトが見つからない場合は、`public/data/dev-projects.json` または `public/data/projects.json` に正しく追加されているか確認してください。

上記の流れに従えば、新しいプロジェクトのオンチェーン設定から UI への反映、そしてデプロイまでを一貫した手順で行うことができます。

